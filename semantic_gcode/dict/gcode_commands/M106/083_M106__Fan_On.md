## M106: Fan On

• RepRapFirmware 3.x

• RepRapFirmware 2.x

##### Parameters

- **Pnnn** Fan number (optional, defaults to 0). Relates to the fan number created by M950,

- **Snnn** Fan speed (0.0-1.0 or \>1.0-255, 0 is off in both cases)

- **Lnnn** Set the minimum fan speed (0.0-1.0 or \>1.0-255, 0 is off in both cases) when a non-zero fan speed is requested.

- **Xnnn** Set the maximum fan speed (0.0-1.0 or \>1.0-255, 0 is off in both cases) when a non-zero fan speed is requested.

- **Bnnn** Blip time - fan will be run at full PWM for this number of seconds when started from standstill. Default is B0.1 which means that there is a 100ms burst after starting the fan.

- **Hnn:nn:nn...** Enable thermostatic mode and select sensor monitored. H-1 disables thermostatic mode. Relates to the sensor number(s) created by M308.

- **Rnnn** Restore fan speed to the value it has when the print was paused (R1) or the last time the fan speed was set and no P parameter was provided (R2).

- **Tnnn** or **Tnn:nn** Set thermostatic mode trigger temperature, or temperature control range

- **C"name"** Set custom name for this fan (supported in RRF \>= 2.01)

##### M106 S127 M106 P1 T45 S0.7 H1:2 ; (RRF 3.3 and earlier, see notes) M106 P1 T45 H1:2 X0.7 ; (RRF 3.4 and later, see notes) M106 P1 T40:50 H1:2

The first example turns on the default cooling fan at half speed. The second (RRF 3.3 and earlier) and third (RRF 3.4 and later) examples sets the second fan to a thermostatic fan for sensors 1 and 2 (e.g. the extruder heaters in a dual-nozzle machine) such that the fan will be on at 70% PWM when either hot end is at or above 45C. The third example also sets up a thermostatic fan, but this time it runs in proportional mode; fan speed scales from 0% to 100% as temperature rises from 40C to 50C.

M308 S10 Y"mcu-temp" A"MCU" ; defines sensor 10 as MCU temperature sensor M308 S11 Y"drivers" A"Duet stepper drivers" ; defines sensor 11 as stepper driver temperature sensor M308 S12 Y"drivers-duex" A"Duex stepper drivers" ; for Duet 2 WiFi/Ethernet with DueX2/5, defines sensor 12 as DueX2/5 stepper driver temps M950 F2 C"fan2" Q100 ; create fan 2 on pin fan2 and set its frequency M106 P2 H10:11:12 T40:70 ; set fan 2 value

This example sets up an electronics cooling fan that starts to turn on when the MCU temperature reaches 45C and reaches full speed when the MCU temperature reaches 70C or if any TMC2660 drivers report that they are over-temperature. The sensors are defined with M308, the fan with M950, then the fan is configured with M106. See Configuring the on-board MCU and stepper driver temperature sensors for further guidance.

##### RepRapFirmware 3 Notes

- The A (logical pin number), F (fan PWM frequency) and I (invert pwm) parameters are no longer supported. Instead, specify the corresponding parameters in the M950 command when you create the fan.

- The **P** parameter relates to the fan number created by M950, NOT the fan pin number on the board as in RRF2.x.

- The **H** parameter relates to the sensor number(s) created by M308, not the temperature sensor pin number on the board as in RRF2.x.

- From RRF 3.4, when a fan is configured as thermostatic using M106, the S parameter is now ignored. If a single T value is given, then when the temperature is above the T parameter the fan will run at the PWM specified by the X (maximum PWM) parameter (default 1.0). In RRF 3.3 and earlier, the fan will run at the PWM specified by the S parameter.

- If a fan is configured to trigger on a sensor that represents a stepper driver over-temperature flags (ie M308 ... Y'drivers'), then when the fan turns on it will delay the reporting of an over-temperature warning for the corresponding drivers for a few seconds, to give the fan time to cool the driver down.

- If you were using the PB6 tacho input on Duet 2 WiFi/Ethernet running RRF 2.x, you must declare this in a M950 command for the fan concerned in RRF 3.x.

Example

; RRF 2.x code M106 P2 I1 F25000 ; fan 2 is a 4-wire PWM fan so invert it and use high PWM frequency. tacho connected to PB6 on expansion connector. PB6 is defined by default. ; RRF 3.x code M950 F2 C"!Fan2+exp.pb6" Q25000 ; fan 2 is a 4-wire PWM fan so invert it, use high PWM frequency, tacho connected to PB6 on expansion connector

##### Parameters

- **Pnnn** Fan number (optional, defaults to 0). (In RRF2 this relates to the fan pin number on the board)

- **Snnn** Fan speed (0.0-1.0 or \>1.0-255, 0 is off in both cases)

- **Innn** Invert PWM (I1), disable fan (I-1), or normal mode (I0, default)

- **Fnnn** Fan PWM frequency

- **Lnnn** Set the minimum fan speed (0.0-1.0 or \>1.0-255, 0 is off in both cases) when a non-zero fan speed is requested.

- **Xnnn** Set the maximum fan speed (0.0-1.0 or \>1.0-255, 0 is off in both cases) when a non-zero fan speed is requested. (supported in RRF \>= 2.02)

- **Bnnn** Blip time - fan will be run at full PWM for this number of seconds when started from standstill. Default is B0.1 which means that there is a 100ms burst after starting the fan.

- **Hnn:nn:nn...** Enable thermostatic mode and select heaters monitored. H-1 disables thermostatic mode. (In RRF2 this relates to the sensor number(s) created by M308, not the temperature sensor pin number on the board)

- **Rnnn** Restore fan speed to the value it has when the print was paused (R1) or the last time the fan speed was set and no P parameter was provided (R2).

- **Tnnn** or **Tnn:nn** Set thermostatic mode trigger temperature, or temperature control range

- **C"name"** Set custom name for this fan (supported in RRF \>= 2.01)

- **Ann** Logical pin number that this fan is connected to (supported in RRF \>= 2.02) (not supported in RRF3, use M950)

##### M106 S127 M106 P1 T45 S0.5 H1:2 M106 P1 T40:50 H1:2 M106 P2 T45:65 H100:101:102

The first example turns on the default cooling fan at half speed. The second example sets the second fan to a thermostatic fan for heaters 1 and 2 (e.g. the extruder heaters in a dual-nozzle machine) such that the fan will be on at 70% PWM when either hot end is at or above 45C. The third example also sets up a thermostatic fan, but this time it runs in proportional mode. The fourth example sets up an electronics cooling fan that starts to turn on when the MCU temperature (virtual heater 100) reaches 45C and reaches full speed when the MCU temperature reaches 65C or if any TMC2660 drivers (virtual heaters 101 and 102) report that they are over-temperature

##### RepRapFirmware 2 Notes

- The **F** parameter sets the fan PWM frequency, in Hz. The default is F250, which works with most fans, try F100 or lower if you find that you can't control the speed of your fan. This parameter is ignored for fans connected to the fan outputs of a DueX2 or DueX5 because those outputs don't support variable PWM frequency.

- The **I** parameter causes the fan output signal to be inverted if its value is greater than zero. This makes the cooling fan output suitable for feeding the PWM input of a 4-wire fan via a diode. If the parameter is present and zero, the output is not inverted. If the I parameter is negative then in RRF 1.16 and later the fan is disabled, which frees up the pin for use as a general purpose I/O pin that can be controlled using M42.

- The **A** parameter can be used to assign a fan to a different output pin, for example a spare heater output (use a M307 command to disable the heater and free up the pin first).

- In firmware versions 1.19 and later, fans can respond to virtual heaters (which have heater numbers 100 upwards) as well as real heaters. If a fan is configured to trigger on a virtual heater whose sensor represents TMC2660 driver over-temperature flags, then when the fan turns on it will delay the reporting of an over-temperature warning for the corresponding drivers for a few seconds, to give the fan time to cool the driver down.

### Notes - all firmware versions

- The parameter **S** declares the PWM value (0.0-1.0 or \>1.0-255, 0 is off in both cases). **M106 S0** turns the fan off.

- If an **S** parameter is provided but no other parameter is present, then the speeds of the print cooling fans associated with the current tool will be set (see the F parameter in the M563 command). If no tool is active then the speed of Fan 0 will be set.

- The **R** parameter allows the fan speed to be set to a remenmbered value. When a pause is commanded, the speed of the print cooling fan for the current tool is remembered in restore point 1. When a tool change is commanded, the speed of the print cooling fan for the current tool is remembered in restore point 2. Either way, if no tool is active then the speed of fan 0 is remembered. These remembered speeds can be recalled using parameter **R1** or **R2** in a subsequent M106 command. In particular, using **M106 R1** in the resume.g macro allows the pause.g macro to switch off the fans and have them resume when the print is resumed. Similarly, using **M106 R2** in tpost#.g files allows the configured fan speed to be passed between tools, which is useful on multi extruder printers where the slicing software may not specify the fan speed on tool change.

- The **T** and **H** parameters allow a fan to be configured to operate in thermostatic mode, for example to use one of the fan channels to control the hot end fan. In this mode the fan will be on when the temperature of any of the heaters listed in the **H** parameter is at or above the trigger temperature set by the **T** parameter, and off otherwise. Thermostatic mode can be disabled using parameter **H-1**. In RRF 3.4 and later, the fan will run at the PWM specified by the **X** (maximum PWM) parameter (default 1.0). In RRF 3.3 and earlier, the fan will run at the PWM specified by the **S** parameter.

- In firmware 1.19 and later, the **T** parameter may be of the form **Taaa:bbb** where aaa is the temperature at/below which the fan should be fully off and bbb is the temperature at which the fan should be fully on. The PWM will be set proportionally if the temperature is between these limits.

- The **B** parameter sets the time for which the fan will be operated at full PWM when started from cold, to allow low fan speeds t be used. A value of 0.1 seconds is usually sufficient.

- The **L** parameter defines the minimum PWM value that is usable with this fan. If a lower value is commanded that is not zero, it will be rounded up to this value.

- The **X** parameter defines the maximum PWM value that is usable with this fan. The requested PWM value (**S** parameter) is scaled to be between 0 and **X** parameter value, and rounded up to the minimum if defined (**L** parameter). e.g. if **X128** is set, **S255** will set PWM to 128; **S128** will set PWM to 64.

